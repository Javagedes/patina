
on:
  workflow_call:

jobs:
  run:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read
      pull-requests: write

    steps:
      - name: âœ… Checkout Repository âœ…
        uses: actions/checkout@v5

      - name: ðŸ› ï¸ Download Rust Tools ðŸ› ï¸
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      # - name: Generate Token
      #   id: app-token
      #   uses: actions/create-github-app-token@v2
      #   with:
      #     app-id: ${{ secrets.PATINA_AUTOMATION_APPLICATION_ID }}
      #     private-key: ${{ secrets.PATINA_AUTOMATION_APPLICATION_PRIVATE_KEY }}
      #     owner: ${{ github.repository_owner }}

      - name: Get Release Tag
        id: release_tag
        run: |
          tag_name="${{ github.event.release.tag_name }}"
          prefix="${{ inputs.ignore-prefix }}"

          # remove leading prefix if it exists
          release_tag="${tag_name#"$prefix"}"

          echo "Release Tag: $release_tag"
          echo "tag=$release_tag" >> $GITHUB_OUTPUT
        shell: bash

      - name: Update git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout New Branch
        run: |
          git checkout -b "github-actions/release-version-update-${{ steps.release_tag.outputs.tag }}"
      
      - name: Run Cargo Release
        run: |
          cargo release version ${{ steps.release_tag.outputs.tag }} --execute --no-confirm
      
      - name: Push Changes
        run: |
          git add .
          git commit -m "Chore: Update crate versions to ${{ steps.release_tag.outputs.tag }}"
          git push origin HEAD:github-actions/release-version-update --force
      
      - name: Create or Update Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const defaultBranch = context.payload.repository.default_branch;
            const headBranch = "github-actions/release-version-update";
            const prTitle = `Chore: Update crate versions to ${{ steps.release_tag.outputs.tag }}`;

            // Check if a PR already exists for the head branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${headBranch}`,
              state: 'open'
            });

            if (prs.length > 0) {
              const existingPr = prs[0];
              console.log(`Pull request already exists: ${existingPr.number}`);

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: existingPr.number,
                title: PrTitle
                });
            } else {
              // Create a new pull request
              const { data: pullRequest } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: headBranch,
                base: defaultBranch,
                body: `An automatically created pull request to update the version of the repo due to a release.",
                draft: false
              });

              console.log(`PR created: ${pullRequest.number}`);
            }